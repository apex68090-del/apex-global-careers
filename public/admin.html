<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Apex Global Careers</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåç</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-title h1 {
            color: #2c3e50;
            font-size: 1.8em;
        }

        .admin-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .logout-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #7f8c8d;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .login-form button {
            width: 100%;
            padding: 14px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .stat-card .stat-number {
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
        }

        .applications-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .applications-table h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px 10px;
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-received {
            background: #f39c12;
            color: white;
        }

        .status-review {
            background: #3498db;
            color: white;
        }

        .status-approved {
            background: #27ae60;
            color: white;
        }

        .status-changes {
            background: #e74c3c;
            color: white;
        }

        .status-processed {
            background: #2c3e50;
            color: white;
        }

        .status-paid {
            background: #27ae60;
            color: white;
        }

        .status-pending-payment {
            background: #f39c12;
            color: white;
        }

        .status-editing-pending {
            background: #9b59b6;
            color: white;
        }

        .status-editing-progress {
            background: #8e44ad;
            color: white;
        }

        .status-editing-ready {
            background: #27ae60;
            color: white;
        }

        .status-job-offer {
            background: #3498db;
            color: white;
        }

        .status-contract {
            background: #9b59b6;
            color: white;
        }

        .status-completed {
            background: #27ae60;
            color: white;
        }

        .action-btn {
            padding: 6px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: #2980b9;
        }

        .action-btn.success {
            background: #27ae60;
        }

        .action-btn.success:hover {
            background: #219a52;
        }

        .action-btn.warning {
            background: #f39c12;
        }

        .action-btn.warning:hover {
            background: #e67e22;
        }

        .action-btn.purple {
            background: #9b59b6;
        }

        .action-btn.purple:hover {
            background: #8e44ad;
        }

        .action-btn.danger {
            background: #e74c3c;
        }

        .action-btn.danger:hover {
            background: #c0392b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 1000px;
            border-radius: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .service-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9em;
            font-weight: 600;
            margin-right: 10px;
        }

        .badge-application {
            background: #3498db;
            color: white;
        }

        .badge-editing {
            background: #9b59b6;
            color: white;
        }

        .badge-job-offer {
            background: #f39c12;
            color: white;
        }

        .badge-contract {
            background: #8e44ad;
            color: white;
        }

        .file-list {
            margin: 20px 0;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .file-item a {
            color: #3498db;
            text-decoration: none;
        }

        .file-item a:hover {
            text-decoration: underline;
        }

        .status-update {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .status-update select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            margin-right: 10px;
            min-width: 200px;
        }

        .comment-section {
            margin-top: 20px;
        }

        .comment-box {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .comment {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .comment small {
            color: #7f8c8d;
            display: block;
            margin-top: 5px;
        }

        .search-box {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .search-box button {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        /* Review Section Styles */
        .review-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .document-review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .document-review-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e0e0e0;
        }

        .document-review-card.approved {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .document-review-card.rejected {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .document-review-card.pending {
            border-color: #f39c12;
            background: #fffaf0;
        }

        .doc-review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .doc-review-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .review-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-approved {
            background: #27ae60;
            color: white;
        }

        .badge-rejected {
            background: #e74c3c;
            color: white;
        }

        .badge-pending {
            background: #f39c12;
            color: white;
        }

        .review-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .review-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-approve {
            background: #27ae60;
            color: white;
        }

        .btn-approve:hover {
            background: #219a52;
        }

        .btn-reject {
            background: #e74c3c;
            color: white;
        }

        .btn-reject:hover {
            background: #c0392b;
        }

        .review-comments {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .reupload-section {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .reupload-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .reupload-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-indicator.approved {
            background: #27ae60;
        }

        .status-indicator.rejected {
            background: #e74c3c;
        }

        .status-indicator.pending {
            background: #f39c12;
        }

        .overall-status {
            font-size: 1.2em;
            font-weight: 600;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .status-approved-bg {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-rejected-bg {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-pending-bg {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .status-changes-bg {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .filter-tab.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .filter-tab:hover {
            background: #e0e0e0;
        }

        .notification-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
        }

        .personal-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .info-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .info-item strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .info-item span {
            color: #2c3e50;
            font-size: 1.1em;
        }

        /* NEW: Job Preferences Section */
        .job-preferences-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9edf5 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .job-preferences-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .job-preferences-section h4 i {
            color: #667eea;
        }

        .job-preferences-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .job-info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #764ba2;
        }

        .job-info-item strong {
            display: block;
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .job-info-item span {
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: 600;
        }

        .additional-info {
            grid-column: span 2;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .additional-info strong {
            display: block;
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .additional-info p {
            color: #2c3e50;
            line-height: 1.5;
        }

        /* Post-Application Section - FIXED for Job Offer and Contract */
        .post-application-section {
            margin: 30px 0;
            padding: 25px;
            background: #e8f5e9;
            border-radius: 15px;
            border-left: 4px solid #27ae60;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .post-header i {
            font-size: 2em;
            color: #27ae60;
        }

        .post-header h3 {
            color: #2c3e50;
            font-size: 1.4em;
        }

        .document-progress {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .document-progress-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #27ae60;
            font-weight: 600;
        }

        .document-progress-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .document-progress-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .document-progress-item .label {
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .document-progress-item .value {
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 700;
        }

        .document-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .document-status.completed {
            color: #27ae60;
        }

        .document-status i {
            font-size: 1.2em;
        }

        .document-upload-area {
            margin-top: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Edit Service Section - UPDATED with Payment Receipts */
        .edit-service-section {
            margin: 30px 0;
            padding: 25px;
            background: #f3e8ff;
            border-radius: 15px;
            border-left: 4px solid #9b59b6;
        }

        .edit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .edit-header i {
            font-size: 2em;
            color: #9b59b6;
        }

        .edit-header h3 {
            color: #2c3e50;
            font-size: 1.4em;
        }

        .edit-progress {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .edit-progress-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #9b59b6;
            font-weight: 600;
        }

        .edit-progress-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .edit-progress-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .edit-progress-item .label {
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .edit-progress-item .value {
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 700;
        }

        .edit-package-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .edit-package-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .edit-package-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #9b59b6;
        }

        .edit-package-item strong {
            display: block;
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 3px;
        }

        .edit-package-item span {
            color: #2c3e50;
            font-weight: 600;
        }

        .edit-documents {
            margin: 20px 0;
        }

        .edit-doc-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .edit-doc-group h5 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .btn-edit-action {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-edit-action.purple {
            background: #9b59b6;
            color: white;
        }

        .btn-edit-action.purple:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        .btn-edit-action.green {
            background: #27ae60;
            color: white;
        }

        .btn-edit-action.green:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .btn-edit-action.blue {
            background: #3498db;
            color: white;
        }

        .btn-edit-action.blue:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .no-edit-request {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #7f8c8d;
            font-style: italic;
        }

        .no-application-message {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            color: #7f8c8d;
            font-style: italic;
            margin: 20px 0;
        }

        /* Payment Receipt Section - NEW */
        .payment-receipt-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #f39c12;
        }

        .payment-receipt-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .payment-receipt-header i {
            font-size: 1.5em;
            color: #f39c12;
        }

        .payment-receipt-header h4 {
            color: #2c3e50;
            font-size: 1.2em;
        }

        .payment-receipt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .payment-receipt-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .payment-receipt-card.pending {
            border-color: #f39c12;
        }

        .payment-receipt-card.verified {
            border-color: #27ae60;
            background: #f0fff4;
        }

        .payment-receipt-card.rejected {
            border-color: #e74c3c;
            background: #fff5f5;
        }

        .receipt-method-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .method-eversend {
            background: #2196F3;
            color: white;
        }

        .method-western-union {
            background: #FF5722;
            color: white;
        }

        .receipt-details {
            margin: 10px 0;
            font-size: 0.9em;
        }

        .receipt-details p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .receipt-details i {
            width: 20px;
            color: #7f8c8d;
        }

        .receipt-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-verify-receipt {
            flex: 1;
            padding: 8px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-verify-receipt:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .btn-view-receipt {
            flex: 1;
            padding: 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-view-receipt:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .receipt-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-verified {
            background: #27ae60;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        /* Payment Section */
        .payment-section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid #27ae60;
        }

        .payment-history-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #27ae60;
        }

        .payment-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .payment-form input,
        .payment-form select,
        .payment-form textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .payment-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }

        .btn-payment {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-payment:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        /* Client Progress */
        .client-progress {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .progress-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .progress-title i {
            font-size: 1.5em;
            color: #3498db;
        }

        .progress-title h4 {
            color: #2c3e50;
            font-size: 1.2em;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .progress-stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .progress-stat-item .label {
            color: #7f8c8d;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .progress-stat-item .value {
            color: #2c3e50;
            font-size: 1.5em;
            font-weight: 700;
        }

        /* Section Toggle */
        .section-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            color: #7f8c8d;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 200px;
        }

        .toggle-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .toggle-btn.purple.active {
            background: #9b59b6;
            border-color: #8e44ad;
        }

        .toggle-btn.green.active {
            background: #27ae60;
            border-color: #27ae60;
        }

        .toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Upload Section Styles */
        .upload-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .upload-section h5 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .file-status .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-status .file-info i {
            color: #27ae60;
        }

        .file-status .file-info span {
            color: #2c3e50;
        }

        .file-status .file-actions {
            display: flex;
            gap: 10px;
        }

        /* Delete Section */
        .delete-section {
            margin: 30px 0;
            padding: 20px;
            background: #fff5f5;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }

        .delete-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #e74c3c;
        }

        .delete-header i {
            font-size: 1.5em;
        }

        .delete-header h4 {
            font-size: 1.2em;
            font-weight: 600;
        }

        .delete-warning {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .delete-warning p {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .delete-warning ul {
            margin-left: 20px;
            color: #7f8c8d;
        }

        .delete-confirm {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .delete-confirm input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .delete-confirm label {
            color: #2c3e50;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }

        .btn-delete:hover:not(:disabled) {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .notification {
            min-width: 320px;
            max-width: 400px;
            padding: 16px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: auto;
            border-left: 4px solid #10b981;
            animation: slideIn 0.3s forwards;
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification.info {
            border-left-color: #3b82f6;
        }

        .notification-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .success .notification-icon {
            background: #10b981;
            color: white;
        }

        .error .notification-icon {
            background: #ef4444;
            color: white;
        }

        .warning .notification-icon {
            background: #f59e0b;
            color: white;
        }

        .info .notification-icon {
            background: #3b82f6;
            color: white;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }

        .notification-close {
            cursor: pointer;
            color: #9ca3af;
            font-size: 20px;
            font-weight: 500;
            padding: 0 4px;
            transition: color 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            color: #4b5563;
        }

        @keyframes slideIn {
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .notification.hide {
            animation: slideOut 0.3s forwards;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(16, 185, 129, 0.3);
            border-radius: 0 0 0 12px;
            animation: progress 3s linear forwards;
        }

        @keyframes progress {
            from { width: 100%; }
            to { width: 0%; }
        }

        @media (max-width: 768px) {
            .personal-info-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-tabs {
                flex-direction: column;
            }

            .progress-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .edit-progress-grid {
                grid-template-columns: 1fr;
            }

            .edit-package-details {
                grid-template-columns: 1fr;
            }

            .edit-actions {
                grid-template-columns: 1fr;
            }

            .section-toggle {
                flex-direction: column;
            }

            .toggle-btn {
                width: 100%;
            }

            .document-progress-grid {
                grid-template-columns: 1fr;
            }

            .job-preferences-grid {
                grid-template-columns: 1fr;
            }
            
            .additional-info {
                grid-column: span 1;
            }

            .notification-container {
                left: 20px;
                right: 20px;
            }
            
            .notification {
                min-width: auto;
                width: 100%;
            }

            .payment-receipt-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Login Section -->
        <div id="loginSection" class="login-container">
            <h2>Admin Login</h2>
            <form id="loginForm" class="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
                <div id="loginError" style="color: #e74c3c; margin-top: 10px; display: none;"></div>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" style="display: none;">
            <div class="admin-header">
                <div class="admin-title">
                    <h1>Apex Global Careers</h1>
                    <span class="admin-badge">Admin Dashboard</span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Requests</h3>
                    <div class="stat-number" id="totalApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Applications</h3>
                    <div class="stat-number" id="appCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Editing Requests</h3>
                    <div class="stat-number" id="editingApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Pending Review</h3>
                    <div class="stat-number" id="pendingApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Under Review</h3>
                    <div class="stat-number" id="reviewApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Changes Required</h3>
                    <div class="stat-number" id="changesApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Approved</h3>
                    <div class="stat-number" id="approvedApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Processed</h3>
                    <div class="stat-number" id="processedApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Job Offers</h3>
                    <div class="stat-number" id="jobOfferApps">0</div>
                </div>
                <div class="stat-card">
                    <h3>Contracts</h3>
                    <div class="stat-number" id="contractApps">0</div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <div class="filter-tab active" onclick="filterApplications('all', event)">All</div>
                <div class="filter-tab" onclick="filterApplications('applications', event)">Applications</div>
                <div class="filter-tab" onclick="filterApplications('pending', event)">Pending Review <span id="pendingCount" class="notification-badge">0</span></div>
                <div class="filter-tab" onclick="filterApplications('review', event)">Under Review</div>
                <div class="filter-tab" onclick="filterApplications('changes', event)">Changes Required</div>
                <div class="filter-tab" onclick="filterApplications('approved', event)">Approved</div>
                <div class="filter-tab" onclick="filterApplications('processed', event)">Processed</div>
                <div class="filter-tab" onclick="filterApplications('job-offer', event)">Job Offer <span id="jobOfferCount" class="notification-badge">0</span></div>
                <div class="filter-tab" onclick="filterApplications('contract', event)">Contract <span id="contractCount" class="notification-badge">0</span></div>
                <div class="filter-tab" onclick="filterApplications('editing', event)">Editing Services <span id="editingCount" class="notification-badge">0</span></div>
                <div class="filter-tab" onclick="filterApplications('payments', event)">Payments</div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by name or email...">
                <button onclick="searchApplications()">Search</button>
            </div>

            <!-- Applications Table -->
            <div class="applications-table">
                <h2>Client Requests</h2>
                <table id="applicationsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Package/Details</th>
                            <th>Status</th>
                            <th>Job Offer</th>
                            <th>Contract</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Application Details Modal -->
        <div id="applicationModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">Client Request Details</h2>
                
                <!-- Service Badges -->
                <div id="serviceBadges" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;"></div>
                
                <!-- Section Toggle Buttons -->
                <div class="section-toggle" id="sectionToggle">
                    <button class="toggle-btn" onclick="showSection('review')" id="reviewToggleBtn">
                        <i class="fas fa-check-circle"></i> Application Review
                    </button>
                    <button class="toggle-btn purple" onclick="showSection('edit')" id="editToggleBtn">
                        <i class="fas fa-pen-fancy"></i> Editing Service
                    </button>
                    <button class="toggle-btn green" onclick="showSection('post')" id="postToggleBtn">
                        <i class="fas fa-file-signature"></i> Post-Application
                    </button>
                </div>
                
                <div id="modalContent">
                    <!-- Content will be loaded here -->
                </div>

                <!-- Delete Section (Always visible at bottom) -->
                <div class="delete-section">
                    <div class="delete-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h4>Danger Zone</h4>
                    </div>
                    <div class="delete-warning">
                        <p><strong>‚ö†Ô∏è Warning:</strong> Deleting this request will permanently remove:</p>
                        <ul>
                            <li>All uploaded documents</li>
                            <li>All comments and reviews</li>
                            <li>Payment history</li>
                            <li>The entire client folder</li>
                        </ul>
                        <p><strong>This action cannot be undone.</strong></p>
                    </div>
                    <div class="delete-confirm">
                        <input type="checkbox" id="confirmDelete" onchange="toggleDeleteButton()">
                        <label for="confirmDelete">I understand that this action is permanent and cannot be reversed</label>
                    </div>
                    <button class="btn-delete" id="deleteRequestBtn" onclick="deleteCurrentRequest()" disabled>
                        <i class="fas fa-trash-alt"></i> Permanently Delete This Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <script>
        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationContainer');
            }

            show(message, options = {}) {
                const {
                    type = 'success',
                    title = 'Success',
                    duration = 4000,
                    showIcon = true,
                    showProgress = true
                } = options;

                const notification = this.createNotification(message, type, title, showIcon);
                
                if (showProgress) {
                    this.addProgressBar(notification, duration);
                }

                this.container.appendChild(notification);

                if (duration > 0) {
                    setTimeout(() => {
                        this.dismiss(notification);
                    }, duration);
                }

                return notification;
            }

            createNotification(message, type, title, showIcon) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;

                const iconMap = {
                    success: '‚úì',
                    error: '‚úó',
                    warning: '!',
                    info: 'i'
                };

                notification.innerHTML = `
                    ${showIcon ? `
                        <div class="notification-icon ${type}">
                            ${iconMap[type] || 'i'}
                        </div>
                    ` : ''}
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <span class="notification-close" onclick="this.parentElement.classList.add('hide'); setTimeout(() => this.parentElement.remove(), 300);">√ó</span>
                `;

                return notification;
            }

            addProgressBar(notification, duration) {
                const progress = document.createElement('div');
                progress.className = 'notification-progress';
                progress.style.animationDuration = `${duration}ms`;
                notification.appendChild(progress);
                notification.style.position = 'relative';
                notification.style.overflow = 'hidden';
            }

            dismiss(notification) {
                notification.classList.add('hide');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }
        }

        // Initialize notification manager
        const notificationManager = new NotificationManager();

        // Helper functions
        function showSuccess(message, title = 'Success') {
            notificationManager.show(message, { type: 'success', title });
        }

        function showError(message, title = 'Error') {
            notificationManager.show(message, { type: 'error', title, duration: 5000 });
        }

        function showWarning(message, title = 'Warning') {
            notificationManager.show(message, { type: 'warning', title, duration: 5000 });
        }

        function showInfo(message, title = 'Information') {
            notificationManager.show(message, { type: 'info', title });
        }

        // ============================================
        // MAIN APPLICATION CODE
        // ============================================
        let currentApplications = [];
        let filteredApplications = [];
        let currentFilter = 'all';
        let currentSection = 'review';
        let currentApplication = null;

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                    await loadAllRequests();
                    showSuccess('Login successful');
                } else {
                    loginError.textContent = 'Invalid credentials';
                    loginError.style.display = 'block';
                    showError('Invalid credentials');
                }
            } catch (error) {
                loginError.textContent = 'Login failed';
                loginError.style.display = 'block';
                showError('Login failed');
            }
        });

        // Load all requests
        async function loadAllRequests() {
            try {
                let allRequests = [];
                
                // Load regular applications
                try {
                    const appResponse = await fetch('/api/admin/applications');
                    const appResult = await appResponse.json();

                    if (appResult.success) {
                        const applications = appResult.applications.map(app => ({
                            ...app,
                            type: 'application',
                            serviceType: 'application',
                            email: app.personalInfo?.email,
                            jobOfferStatus: app.jobOffer?.status || 'pending',
                            contractStatus: app.contract?.status || 'pending',
                            jobOfferFile: app.jobOffer?.file || null,
                            contractFile: app.contract?.file || null,
                            displayType: 'üìÑ Application'
                        }));
                        allRequests = [...allRequests, ...applications];
                    }
                } catch (error) {
                    console.error('Error loading applications:', error);
                    showError('Failed to load applications');
                }

                // Load editing requests
                try {
                    const editResponse = await fetch('/api/editing/admin/all');
                    const editResult = await editResponse.json();

                    if (editResult.success) {
                        const editingRequests = editResult.requests.map(req => ({
                            ...req,
                            type: 'editing',
                            mode: 'editing',
                            serviceType: 'editing',
                            email: req.personalInfo?.email,
                            timestamp: req.createdAt,
                            personalInfo: req.personalInfo,
                            status: req.status,
                            paymentStatus: req.paymentStatus,
                            packageType: req.serviceType,
                            amount: req.amount,
                            originalFiles: req.originalFiles || {},
                            editedFiles: req.editedFiles || {},
                            jobOfferStatus: 'not_applicable',
                            contractStatus: 'not_applicable',
                            displayType: '‚úèÔ∏è Editing'
                        }));
                        
                        allRequests = [...allRequests, ...editingRequests];
                        console.log('‚úÖ Loaded editing requests:', editingRequests.length);
                    }
                } catch (error) {
                    console.error('Error loading editing requests:', error);
                }

                // Sort by date (newest first)
                currentApplications = allRequests.sort((a, b) => {
                    return new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt);
                });

                // Apply current filter
                filterApplications('all', { target: document.querySelector('.filter-tab.active') });
                updateStats();

            } catch (error) {
                console.error('Error loading requests:', error);
                showError('Failed to load requests');
            }
        }

        // Update statistics
        function updateStats() {
            const total = currentApplications.length;
            const applications = currentApplications.filter(a => a.type === 'application');
            const editing = currentApplications.filter(a => a.type === 'editing');
            const pending = applications.filter(a => a.status === 'received' || a.status === 'reupload-requested').length;
            const review = applications.filter(a => a.status === 'review').length;
            const changes = applications.filter(a => a.status === 'changes-required').length;
            const approved = applications.filter(a => a.status === 'documents-approved').length;
            const processed = applications.filter(a => a.status === 'processed').length;
            const payments = currentApplications.filter(a => a.paymentStatus === 'paid').length;
            
            // Stats for job offer and contract
            const jobOffer = applications.filter(a => a.jobOfferStatus === 'uploaded' || a.jobOfferStatus === 'approved').length;
            const contract = applications.filter(a => a.contractStatus === 'uploaded' || a.contractStatus === 'approved').length;

            document.getElementById('totalApps').textContent = total;
            document.getElementById('appCount').textContent = applications.length;
            document.getElementById('editingApps').textContent = editing.length;
            document.getElementById('pendingApps').textContent = pending;
            document.getElementById('reviewApps').textContent = review;
            document.getElementById('changesApps').textContent = changes;
            document.getElementById('approvedApps').textContent = approved;
            document.getElementById('processedApps').textContent = processed;
            document.getElementById('paymentApps').textContent = payments;
            document.getElementById('jobOfferApps').textContent = jobOffer;
            document.getElementById('contractApps').textContent = contract;
            document.getElementById('editingCount').textContent = editing.length;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('jobOfferCount').textContent = jobOffer;
            document.getElementById('contractCount').textContent = contract;
        }

        // Filter applications
        function filterApplications(filter, event) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            switch(filter) {
                case 'applications':
                    filteredApplications = currentApplications.filter(a => a.type === 'application');
                    break;
                case 'pending':
                    filteredApplications = currentApplications.filter(a => 
                        a.type === 'application' && 
                        (a.status === 'received' || a.status === 'reupload-requested')
                    );
                    break;
                case 'review':
                    filteredApplications = currentApplications.filter(a => 
                        a.type === 'application' && a.status === 'review'
                    );
                    break;
                case 'changes':
                    filteredApplications = currentApplications.filter(a => 
                        a.type === 'application' && a.status === 'changes-required'
                    );
                    break;
                case 'approved':
                    filteredApplications = currentApplications.filter(a => 
                        a.type === 'application' && a.status === 'documents-approved'
                    );
                    break;
                case 'processed':
                    filteredApplications = currentApplications.filter(a => 
                        a.type === 'application' && a.status === 'processed'
                    );
                    break;
                case 'job-offer':
                    filteredApplications = currentApplications.filter(a => 
                        a.type === 'application' && 
                        (a.jobOfferStatus === 'uploaded' || a.jobOfferStatus === 'approved')
                    );
                    break;
                case 'contract':
                    filteredApplications = currentApplications.filter(a => 
                        a.type === 'application' && 
                        (a.contractStatus === 'uploaded' || a.contractStatus === 'approved')
                    );
                    break;
                case 'editing':
                    filteredApplications = currentApplications.filter(a => a.type === 'editing');
                    break;
                case 'payments':
                    filteredApplications = currentApplications.filter(a => a.paymentStatus === 'paid');
                    break;
                default:
                    filteredApplications = currentApplications;
            }

            displayApplications(filteredApplications);
        }

        // Display applications in table
        function displayApplications(applications) {
            const tbody = document.getElementById('tableBody');
            
            if (applications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No requests found</td></tr>';
                return;
            }

            tbody.innerHTML = applications.map(app => {
                const date = new Date(app.timestamp || app.createdAt).toLocaleDateString();
                
                let statusClass = '';
                let statusText = app.status || 'Received';
                let packageText = 'N/A';
                
                // Job offer and contract status badges
                let jobOfferBadge = '';
                let contractBadge = '';
                
                if (app.type === 'application') {
                    // Job offer status
                    if (app.jobOfferStatus === 'approved') {
                        jobOfferBadge = '<span class="status-badge status-approved">‚úÖ Approved</span>';
                    } else if (app.jobOfferStatus === 'uploaded') {
                        jobOfferBadge = '<span class="status-badge status-job-offer">üìÑ Uploaded</span>';
                    } else if (app.status === 'processed') {
                        jobOfferBadge = '<span class="status-badge status-pending">‚è≥ Awaiting</span>';
                    } else {
                        jobOfferBadge = '<span class="status-badge status-pending">‚è≥ N/A</span>';
                    }
                    
                    // Contract status
                    if (app.contractStatus === 'approved') {
                        contractBadge = '<span class="status-badge status-approved">‚úÖ Approved</span>';
                    } else if (app.contractStatus === 'uploaded') {
                        contractBadge = '<span class="status-badge status-contract">üìù Uploaded</span>';
                    } else if (app.status === 'processed') {
                        contractBadge = '<span class="status-badge status-pending">‚è≥ Awaiting</span>';
                    } else {
                        contractBadge = '<span class="status-badge status-pending">‚è≥ N/A</span>';
                    }
                } else {
                    jobOfferBadge = '<span class="status-badge status-pending">N/A</span>';
                    contractBadge = '<span class="status-badge status-pending">N/A</span>';
                }
                
                if (app.type === 'editing') {
                    // Editing service display
                    if (app.packageType === 'cv' || app.serviceType === 'cv') {
                        packageText = 'CV Only ($20)';
                    } else if (app.packageType === 'cover' || app.serviceType === 'cover') {
                        packageText = 'Cover Letter Only ($20)';
                    } else if (app.packageType === 'both' || app.serviceType === 'both') {
                        packageText = 'CV + Cover Letter ($30)';
                    }
                    
                    if (app.status === 'pending') {
                        statusClass = 'status-editing-pending';
                        statusText = 'Pending Editing';
                    } else if (app.status === 'editing_in_progress') {
                        statusClass = 'status-editing-progress';
                        statusText = 'Editing in Progress';
                    } else if (app.status === 'editing_completed') {
                        statusClass = 'status-editing-ready';
                        statusText = 'Ready for Payment';
                    } else if (app.status === 'payment_pending') {
                        statusClass = 'status-pending-payment';
                        statusText = 'Payment Pending Verification';
                    } else if (app.status === 'editing_paid') {
                        statusClass = 'status-approved';
                        statusText = 'Complete';
                    } else {
                        statusClass = 'status-editing-pending';
                    }
                } else {
                    // Application display
                    if (app.status === 'received' || app.status === 'reupload-requested') {
                        statusClass = 'status-received';
                        statusText = app.status === 'reupload-requested' ? 'Re-upload Needed' : 'Received';
                    } else if (app.status === 'review') {
                        statusClass = 'status-review';
                        statusText = 'Under Review';
                    } else if (app.status === 'documents-approved') {
                        statusClass = 'status-approved';
                        statusText = 'Approved';
                    } else if (app.status === 'changes-required') {
                        statusClass = 'status-changes';
                        statusText = 'Changes Required';
                    } else if (app.status === 'processed') {
                        statusClass = 'status-processed';
                        statusText = 'Processed';
                    } else {
                        statusClass = 'status-received';
                    }
                }

                const paymentStatus = app.paymentStatus || 'pending';
                const paymentText = paymentStatus === 'paid' ? '‚úÖ Paid' : 
                                   paymentStatus === 'submitted' ? '‚è≥ Pending Verify' : '‚è≥ Pending';

                return `
                    <tr>
                        <td>${date}</td>
                        <td>${app.personalInfo?.fullName || 'N/A'}</td>
                        <td>${app.personalInfo?.email || app.email || 'N/A'}</td>
                        <td>${app.displayType || (app.type === 'editing' ? '‚úèÔ∏è Editing' : 'üìÑ Application')}</td>
                        <td>${packageText}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${jobOfferBadge}</td>
                        <td>${contractBadge}</td>
                        <td><span class="status-badge ${paymentStatus === 'paid' ? 'status-approved' : paymentStatus === 'submitted' ? 'status-pending-payment' : 'status-received'}">${paymentText}</span></td>
                        <td>
                            <button class="action-btn" onclick="viewApplication('${app.personalInfo?.email || app.email}', '${app.type}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Search applications
        function searchApplications() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                displayApplications(filteredApplications);
                return;
            }

            const searched = filteredApplications.filter(app => 
                (app.personalInfo?.fullName?.toLowerCase() || '').includes(searchTerm) ||
                (app.personalInfo?.email?.toLowerCase() || '').includes(searchTerm)
            );
            
            displayApplications(searched);
        }

        // View application details
        async function viewApplication(email, type) {
            try {
                let applicationData = null;
                let editingData = null;
                
                if (type === 'application') {
                    const response = await fetch(`/api/admin/application/${email}`);
                    const result = await response.json();
                    if (result.success) {
                        applicationData = { ...result.application, type: 'application' };
                    }
                } else if (type === 'editing') {
                    const response = await fetch(`/api/editing/admin/status/${encodeURIComponent(email)}`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            editingData = {
                                ...result.status,
                                type: 'editing',
                                mode: 'editing',
                                originalFiles: result.status.originalFiles || {},
                                editedFiles: result.status.editedFiles || {},
                                paymentReceipts: result.status.paymentReceipts || [] // Include payment receipts
                            };
                        }
                    }
                } else {
                    try {
                        const appResponse = await fetch(`/api/admin/application/${email}`);
                        const appResult = await appResponse.json();
                        if (appResult.success) {
                            applicationData = { ...appResult.application, type: 'application' };
                        }
                    } catch (error) {
                        console.log('No application found');
                    }

                    try {
                        const editResponse = await fetch(`/api/editing/admin/status/${encodeURIComponent(email)}`);
                        if (editResponse.ok) {
                            const editResult = await editResponse.json();
                            if (editResult.success) {
                                editingData = {
                                    ...editResult.status,
                                    type: 'editing',
                                    mode: 'editing',
                                    originalFiles: editResult.status.originalFiles || {},
                                    editedFiles: editResult.status.editedFiles || {},
                                    paymentReceipts: editResult.status.paymentReceipts || []
                                };
                            }
                        }
                    } catch (error) {
                        console.log('No editing request found');
                    }
                }

                currentApplication = {
                    email: email,
                    personalInfo: applicationData?.personalInfo || editingData?.personalInfo || {},
                    hasApplication: !!applicationData,
                    hasEditing: !!editingData,
                    application: applicationData,
                    editing: editingData,
                    jobOffer: applicationData?.jobOffer || { status: 'pending', file: null },
                    contract: applicationData?.contract || { status: 'pending', file: null },
                    comments: [
                        ...(applicationData?.comments || []),
                        ...(editingData?.comments || [])
                    ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                };

                showApplicationModal(currentApplication);

            } catch (error) {
                console.error('Error loading request:', error);
                showError('Error loading request');
            }
        }

        // Show section
        function showSection(section) {
            currentSection = section;
            
            document.getElementById('reviewToggleBtn').classList.toggle('active', section === 'review');
            document.getElementById('editToggleBtn').classList.toggle('active', section === 'edit');
            document.getElementById('postToggleBtn').classList.toggle('active', section === 'post');
            
            if (currentApplication) {
                showApplicationModal(currentApplication);
            }
        }

        // Helper functions
        function formatGender(gender) {
            const formats = {
                'male': 'Male',
                'female': 'Female',
                'other': 'Other',
                'prefer-not-to-say': 'Prefer not to say'
            };
            return formats[gender] || gender || 'N/A';
        }

        function formatMaritalStatus(status) {
            const formats = {
                'single': 'Single',
                'married': 'Married',
                'divorced': 'Divorced',
                'widowed': 'Widowed',
                'other': 'Other'
            };
            return formats[status] || status || 'N/A';
        }

        function formatDocName(key) {
            const names = {
                'passport': 'Passport',
                'photo': 'Passport Photo',
                'cv': 'CV/Resume',
                'coverLetter': 'Cover Letter',
                'qualifications': 'Qualifications',
                'experience': 'Experience Letters',
                'edited_cv': 'Edited CV',
                'edited_cover': 'Edited Cover Letter',
                'jobOffer': 'Job Offer Letter',
                'contract': 'Employment Contract'
            };
            return names[key] || key;
        }

        // Toggle delete button
        function toggleDeleteButton() {
            const checkbox = document.getElementById('confirmDelete');
            const deleteBtn = document.getElementById('deleteRequestBtn');
            deleteBtn.disabled = !checkbox.checked;
        }

        // Delete current request
        async function deleteCurrentRequest() {
            if (!currentApplication) {
                showError('No request selected');
                return;
            }

            const email = currentApplication.email;
            
            if (!confirm(`Are you ABSOLUTELY sure you want to delete all requests for ${email}? This action CANNOT be undone.`)) {
                return;
            }

            const deleteBtn = document.getElementById('deleteRequestBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            deleteBtn.disabled = true;

            try {
                let success = true;
                
                if (currentApplication.hasApplication) {
                    const appResponse = await fetch(`/api/admin/application/${encodeURIComponent(email)}`, {
                        method: 'DELETE'
                    });
                    if (!appResponse.ok) success = false;
                }
                
                if (currentApplication.hasEditing) {
                    const editResponse = await fetch(`/api/editing/delete/${encodeURIComponent(email)}`, {
                        method: 'DELETE'
                    });
                    if (!editResponse.ok) success = false;
                }

                if (success) {
                    showSuccess('‚úÖ All requests permanently deleted');
                    closeModal();
                    await loadAllRequests();
                } else {
                    showError('‚ùå Some deletions failed');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showError('‚ùå Failed to delete requests');
            } finally {
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = !document.getElementById('confirmDelete').checked;
            }
        }

        // Update status
        async function updateStatus(email) {
            const status = document.getElementById('statusSelect').value;
            
            try {
                let response;
                let type = 'application';
                
                if (currentSection === 'edit' && currentApplication.hasEditing) {
                    response = await fetch(`/api/editing/status/${encodeURIComponent(email)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                    type = 'editing';
                } else if (currentSection === 'review' && currentApplication.hasApplication) {
                    response = await fetch(`/api/admin/application/${email}/status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                } else {
                    showError('No suitable request found to update');
                    return;
                }

                if (response.ok) {
                    showSuccess(`${type === 'editing' ? 'Editing' : 'Application'} status updated successfully`);
                    await viewApplication(email, type);
                    await loadAllRequests();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to update status');
                }
            } catch (error) {
                console.error('Status update error:', error);
                showError('Failed to update status');
            }
        }

        // Update job offer status
        async function updateJobOfferStatus(email, status) {
            try {
                const response = await fetch(`/api/admin/application/${email}/job-offer/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    showSuccess(`‚úÖ Job offer status updated to ${status}`);
                    await viewApplication(email, 'application');
                    await loadAllRequests();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to update job offer status');
                }
            } catch (error) {
                console.error('Job offer update error:', error);
                showError('Failed to update job offer status');
            }
        }

        // Update contract status
        async function updateContractStatus(email, status) {
            try {
                const response = await fetch(`/api/admin/application/${email}/contract/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    showSuccess(`‚úÖ Contract status updated to ${status}`);
                    await viewApplication(email, 'application');
                    await loadAllRequests();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to update contract status');
                }
            } catch (error) {
                console.error('Contract update error:', error);
                showError('Failed to update contract status');
            }
        }

        // Add comment
        async function addComment(email) {
            const comment = document.getElementById('newComment').value;
            if (!comment.trim()) {
                showWarning('Please enter a comment');
                return;
            }

            try {
                let success = true;
                
                if (currentApplication.hasApplication) {
                    const appResponse = await fetch(`/api/admin/application/${email}/comment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ comment })
                    });
                    if (!appResponse.ok) success = false;
                }
                
                if (currentApplication.hasEditing) {
                    const editResponse = await fetch(`/api/editing/comment/${encodeURIComponent(email)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ comment })
                    });
                    if (!editResponse.ok) success = false;
                }

                if (success) {
                    document.getElementById('newComment').value = '';
                    showSuccess('‚úÖ Comment added');
                    await viewApplication(email);
                } else {
                    showError('‚ùå Failed to add comment to some services');
                }
            } catch (error) {
                console.error('Comment error:', error);
                showError('‚ùå Failed to add comment');
            }
        }

        // Document Review Functions
        async function reviewDocument(email, documentType, status) {
            let comments = '';
            if (status === 'rejected') {
                comments = prompt('Reason for rejection:');
                if (!comments) return;
            }

            try {
                const response = await fetch(`/api/admin/application/${email}/document/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documentType, status, comments })
                });

                if (response.ok) {
                    showSuccess(`‚úÖ Document ${status}`);
                    await viewApplication(email, 'application');
                    await loadAllRequests();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to update');
                }
            } catch (error) {
                showError('Failed to update');
            }
        }

        // Request re-upload
        async function requestReupload(email) {
            const checkboxes = document.querySelectorAll('#reuploadCheckboxes input:checked');
            const documents = Array.from(checkboxes).map(cb => cb.value);
            const message = document.getElementById('reuploadMessage').value;

            if (documents.length === 0) {
                showWarning('Please select documents');
                return;
            }

            if (!message.trim()) {
                showWarning('Please provide a message');
                return;
            }

            try {
                const response = await fetch(`/api/admin/application/${email}/request-reupload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documents, message })
                });

                if (response.ok) {
                    showSuccess('‚úÖ Re-upload requested');
                    await viewApplication(email, 'application');
                    await loadAllRequests();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to request re-upload');
                }
            } catch (error) {
                showError('Failed to request re-upload');
            }
        }

        // EDITING SERVICE FUNCTIONS
        async function startEditing(email) {
            try {
                const response = await fetch(`/api/editing/status/${encodeURIComponent(email)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'editing_in_progress' })
                });

                if (response.ok) {
                    showSuccess('‚úÖ Editing started');
                    await viewApplication(email, 'editing');
                    await loadAllRequests();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to start editing');
                }
            } catch (error) {
                showError('Failed to start editing');
            }
        }

        // Upload Edited CV
        async function uploadEditedCV(email) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.doc,.docx';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('edited_cv', file);

                try {
                    const response = await fetch(`/api/editing/upload-edited/${encodeURIComponent(email)}`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccess('‚úÖ Edited CV uploaded successfully');
                        await viewApplication(email, 'editing');
                        await loadAllRequests();
                    } else {
                        showError(result.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showError('Failed to upload CV');
                }
            };

            input.click();
        }

        // Upload Edited Cover Letter
        async function uploadEditedCover(email) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf,.doc,.docx';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('edited_cover', file);

                try {
                    const response = await fetch(`/api/editing/upload-edited/${encodeURIComponent(email)}`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccess('‚úÖ Edited Cover Letter uploaded successfully');
                        await viewApplication(email, 'editing');
                        await loadAllRequests();
                    } else {
                        showError(result.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showError('Failed to upload Cover Letter');
                }
            };

            input.click();
        }

        // Mark ready for payment
        async function markReadyForPayment(email) {
            try {
                const response = await fetch(`/api/editing/status/${encodeURIComponent(email)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'editing_completed' })
                });

                if (response.ok) {
                    showSuccess('‚úÖ Ready for payment');
                    await viewApplication(email, 'editing');
                    await loadAllRequests();
                } else {
                    const error = await response.json();
                    showError(error.error || 'Failed to update');
                }
            } catch (error) {
                showError('Failed to update');
            }
        }

        // NEW: Verify payment receipt
        async function verifyPaymentReceipt(email, receiptIndex) {
            const verificationNotes = prompt('Add verification notes (optional):');
            
            try {
                const response = await fetch(`/api/editing/verify-payment/${encodeURIComponent(email)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        receiptIndex, 
                        verificationNotes: verificationNotes || '' 
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('‚úÖ Payment verified successfully');
                    await viewApplication(email, 'editing');
                    await loadAllRequests();
                } else {
                    showError(result.error || 'Verification failed');
                }
            } catch (error) {
                console.error('Payment verification error:', error);
                showError('Verification failed');
            }
        }

        // Show application modal
        function showApplicationModal(app) {
            const modal = document.getElementById('applicationModal');
            const content = document.getElementById('modalContent');
            const personalInfo = app.personalInfo || {};
            const jobPreferences = app.application?.jobPreferences || {};

            // Update service badges
            const badgesDiv = document.getElementById('serviceBadges');
            badgesDiv.innerHTML = '';
            if (app.hasApplication) {
                badgesDiv.innerHTML += '<span class="service-badge badge-application"><i class="fas fa-file-alt"></i> Visa Application</span>';
            }
            if (app.hasEditing) {
                badgesDiv.innerHTML += '<span class="service-badge badge-editing"><i class="fas fa-pen-fancy"></i> Editing Service</span>';
            }

            // Show/hide toggle buttons based on what the client has
            document.getElementById('reviewToggleBtn').style.display = app.hasApplication ? 'flex' : 'none';
            document.getElementById('editToggleBtn').style.display = app.hasEditing ? 'flex' : 'none';
            document.getElementById('postToggleBtn').style.display = (app.hasApplication && app.application?.status === 'processed') ? 'flex' : 'none';
            
            // If only one service exists, set it as active
            if (!app.hasApplication && app.hasEditing) {
                currentSection = 'edit';
                document.getElementById('reviewToggleBtn').classList.remove('active');
                document.getElementById('editToggleBtn').classList.add('active');
                document.getElementById('postToggleBtn').classList.remove('active');
            } else if (app.hasApplication && !app.hasEditing) {
                if (app.application?.status === 'processed') {
                    currentSection = 'post';
                    document.getElementById('reviewToggleBtn').classList.remove('active');
                    document.getElementById('editToggleBtn').classList.remove('active');
                    document.getElementById('postToggleBtn').classList.add('active');
                } else {
                    currentSection = 'review';
                    document.getElementById('reviewToggleBtn').classList.add('active');
                    document.getElementById('editToggleBtn').classList.remove('active');
                    document.getElementById('postToggleBtn').classList.remove('active');
                }
            }

            // Calculate stats for applications only
            const applicationData = app.application;
            const uploadCount = applicationData?.uploadCount || 1;
            const remainingUploads = 3 - uploadCount;
            const totalDocs = Object.keys(applicationData?.uploadedFiles || {}).length;
            const reviewedDocs = Object.values(applicationData?.documentReviews || {}).filter(r => r?.status !== 'pending').length;

            // REVIEW SECTION - ONLY for visa applications
            const reviewSection = app.hasApplication ? `
                <div class="application-section">
                    <div class="overall-status ${applicationData?.status === 'documents-approved' ? 'status-approved-bg' : 
                                                 applicationData?.status === 'changes-required' ? 'status-changes-bg' : 
                                                 applicationData?.status === 'reupload-requested' ? 'status-pending-bg' :
                                                 applicationData?.status === 'processed' ? 'status-approved-bg' :
                                                 'status-pending-bg'}">
                        <strong>Application Status:</strong> ${applicationData?.status === 'reupload-requested' ? 'Re-upload Needed' : 
                                                              applicationData?.status === 'documents-approved' ? 'Approved' :
                                                              applicationData?.status === 'changes-required' ? 'Changes Required' :
                                                              applicationData?.status === 'review' ? 'Under Review' :
                                                              applicationData?.status === 'processed' ? 'Processed' :
                                                              applicationData?.status || 'Pending'}
                    </div>

                    <div class="status-update">
                        <h3>Update Application Status</h3>
                        <select id="statusSelect">
                            <option value="received" ${applicationData?.status === 'received' ? 'selected' : ''}>Documents Received</option>
                            <option value="review" ${applicationData?.status === 'review' ? 'selected' : ''}>Under Review</option>
                            <option value="documents-approved" ${applicationData?.status === 'documents-approved' ? 'selected' : ''}>Documents Approved</option>
                            <option value="changes-required" ${applicationData?.status === 'changes-required' ? 'selected' : ''}>Changes Required</option>
                            <option value="reupload-requested" ${applicationData?.status === 'reupload-requested' ? 'selected' : ''}>Re-upload Needed</option>
                            <option value="processed" ${applicationData?.status === 'processed' ? 'selected' : ''}>Processed</option>
                        </select>
                        <button class="action-btn" onclick="updateStatus('${personalInfo.email}')">Update</button>
                    </div>

                    <div class="client-progress">
                        <div class="progress-title">
                            <i class="fas fa-chart-line"></i>
                            <h4>Application Progress</h4>
                        </div>
                        <div class="progress-stats">
                            <div class="progress-stat-item">
                                <div class="label">Upload Attempts</div>
                                <div class="value">${uploadCount}/3</div>
                            </div>
                            <div class="progress-stat-item">
                                <div class="label">Documents</div>
                                <div class="value">${totalDocs}</div>
                            </div>
                            <div class="progress-stat-item">
                                <div class="label">Reviewed</div>
                                <div class="value">${reviewedDocs}/${totalDocs}</div>
                            </div>
                            <div class="progress-stat-item">
                                <div class="label">Remaining</div>
                                <div class="value">${remainingUploads}</div>
                            </div>
                        </div>
                    </div>

                    <div class="review-section">
                        <h3>Document Review</h3>
                        <div class="document-review-grid">
                            ${['passport', 'photo', 'cv', 'coverLetter', 'qualifications', 'experience'].map(key => {
                                const review = applicationData?.documentReviews?.[key] || { status: 'pending' };
                                const label = key === 'coverLetter' ? 'Cover Letter' : 
                                            key === 'cv' ? 'CV/Resume' :
                                            key.charAt(0).toUpperCase() + key.slice(1);
                                const statusClass = review.status === 'approved' ? 'approved' : 
                                                   review.status === 'rejected' ? 'rejected' : 'pending';
                                
                                return `
                                    <div class="document-review-card ${statusClass}">
                                        <div class="doc-review-header">
                                            <span class="doc-review-title">${label}</span>
                                            <span class="review-badge badge-${review.status || 'pending'}">
                                                ${review.status || 'pending'}
                                            </span>
                                        </div>
                                        ${review.comments ? `
                                            <div class="review-comments">
                                                <small>üìù ${review.comments}</small>
                                            </div>
                                        ` : ''}
                                        <div class="review-actions">
                                            <button class="review-btn btn-approve" onclick="reviewDocument('${personalInfo.email}', '${key}', 'approved')">
                                                ‚úì Approve
                                            </button>
                                            <button class="review-btn btn-reject" onclick="reviewDocument('${personalInfo.email}', '${key}', 'rejected')">
                                                ‚úó Reject
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="reupload-section">
                        <h4>Request Document Re-upload</h4>
                        <div class="reupload-checkbox-group" id="reuploadCheckboxes">
                            ${['passport', 'photo', 'cv', 'coverLetter', 'qualifications', 'experience'].map(key => `
                                <label class="reupload-checkbox">
                                    <input type="checkbox" value="${key}"> ${formatDocName(key)}
                                </label>
                            `).join('')}
                        </div>
                        <textarea id="reuploadMessage" class="comment-box" placeholder="Explain why re-upload is needed..."></textarea>
                        <button class="action-btn" onclick="requestReupload('${personalInfo.email}')">Request Re-upload</button>
                    </div>
                </div>
            ` : '<div class="no-application-message"><i class="fas fa-info-circle"></i> No visa application found for this client.</div>';

            // EDIT SECTION - UPDATED with payment receipts
            let editSection = '';
            
            if (app.hasEditing) {
                const editingData = app.editing;
                const needsCv = editingData?.serviceType === 'cv' || editingData?.serviceType === 'both';
                const needsCover = editingData?.serviceType === 'cover' || editingData?.serviceType === 'both';
                const paymentReceipts = editingData?.paymentReceipts || [];
                
                // Check for original files
                const hasOriginalCv = !!(editingData?.originalFiles?.cv);
                const hasOriginalCover = !!(editingData?.originalFiles?.cover);
                
                // Get original file details
                const originalCvFile = editingData?.originalFiles?.cv;
                const originalCoverFile = editingData?.originalFiles?.cover;
                
                // Check for edited files
                const hasEditedCv = !!(editingData?.editedFiles?.cv?.final);
                const hasEditedCover = !!(editingData?.editedFiles?.cover?.final);
                
                // Get edited file details
                const editedCvFile = editingData?.editedFiles?.cv?.final;
                const editedCoverFile = editingData?.editedFiles?.cover?.final;
                
                const totalNeeded = (needsCv ? 1 : 0) + (needsCover ? 1 : 0);
                const completed = (hasEditedCv ? 1 : 0) + (hasEditedCover ? 1 : 0);
                const progressPercent = totalNeeded > 0 ? Math.round((completed / totalNeeded) * 100) : 0;

                // Generate payment receipts HTML
                let paymentReceiptsHtml = '';
                if (paymentReceipts.length > 0) {
                    paymentReceiptsHtml = `
                        <div class="payment-receipt-section">
                            <div class="payment-receipt-header">
                                <i class="fas fa-receipt"></i>
                                <h4>Payment Receipts</h4>
                                <span class="receipt-status-badge status-${editingData.paymentStatus === 'paid' ? 'verified' : 'pending'}">
                                    ${editingData.paymentStatus === 'paid' ? '‚úÖ Verified' : '‚è≥ Pending Verification'}
                                </span>
                            </div>
                            <div class="payment-receipt-grid">
                                ${paymentReceipts.map((receipt, index) => {
                                    const methodClass = receipt.paymentMethod === 'eversend' ? 'method-eversend' : 'method-western-union';
                                    const methodName = receipt.paymentMethod === 'eversend' ? 'Eversend/M-Pesa' : 'Western Union';
                                    const statusClass = receipt.status === 'verified' ? 'verified' : 'pending';
                                    
                                    return `
                                        <div class="payment-receipt-card ${statusClass}">
                                            <div class="receipt-method-badge ${methodClass}">
                                                <i class="fas ${receipt.paymentMethod === 'eversend' ? 'fa-mobile-alt' : 'fa-university'}"></i>
                                                ${methodName}
                                            </div>
                                            <div class="receipt-details">
                                                <p><i class="fas fa-user"></i> ${receipt.senderDetails?.name || 'N/A'}</p>
                                                <p><i class="fas fa-phone"></i> ${receipt.senderDetails?.phone || 'N/A'}</p>
                                                <p><i class="fas fa-globe"></i> ${receipt.senderDetails?.country || 'N/A'}</p>
                                                <p><i class="fas fa-dollar-sign"></i> $${receipt.amount || editingData?.amount || '0'}</p>
                                                <p><i class="fas fa-calendar"></i> ${new Date(receipt.submittedAt).toLocaleString()}</p>
                                                ${receipt.transactionReference ? `<p><i class="fas fa-hashtag"></i> Ref: ${receipt.transactionReference}</p>` : ''}
                                                ${receipt.notes ? `<p><i class="fas fa-sticky-note"></i> ${receipt.notes}</p>` : ''}
                                            </div>
                                            <div class="receipt-actions">
                                                <a href="/api/editing/files/${personalInfo.email}/${receipt.receipt.filename}" target="_blank" class="btn-view-receipt">
                                                    <i class="fas fa-eye"></i> View Receipt
                                                </a>
                                                ${receipt.status === 'pending' ? `
                                                    <button class="btn-verify-receipt" onclick="verifyPaymentReceipt('${personalInfo.email}', ${index})">
                                                        <i class="fas fa-check-circle"></i> Verify
                                                    </button>
                                                ` : `
                                                    <span class="receipt-status-badge status-verified">
                                                        <i class="fas fa-check"></i> Verified
                                                    </span>
                                                `}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                editSection = `
                    <div class="edit-service-section">
                        <div class="edit-header">
                            <i class="fas fa-pen-fancy"></i>
                            <h3>Editing Service Dashboard</h3>
                        </div>

                        <div class="edit-progress">
                            <div class="edit-progress-title">
                                <i class="fas fa-chart-pie"></i>
                                <span>Edit Progress</span>
                            </div>
                            <div class="edit-progress-grid">
                                <div class="edit-progress-item">
                                    <div class="label">Progress</div>
                                    <div class="value">${progressPercent}%</div>
                                </div>
                                <div class="edit-progress-item">
                                    <div class="label">Completed</div>
                                    <div class="value">${completed}/${totalNeeded}</div>
                                </div>
                                <div class="edit-progress-item">
                                    <div class="label">Status</div>
                                    <div class="value">
                                        ${editingData?.status === 'pending' ? '‚è≥ Pending' :
                                          editingData?.status === 'editing_in_progress' ? '‚úèÔ∏è In Progress' :
                                          editingData?.status === 'editing_completed' ? '‚úÖ Ready for Payment' :
                                          editingData?.status === 'payment_pending' ? '‚è≥ Payment Pending' :
                                          editingData?.status === 'editing_paid' ? 'üí∞ Paid' : 'Unknown'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="edit-package-info">
                            <h4 style="margin-bottom: 15px;">Package Details</h4>
                            <div class="edit-package-details">
                                <div class="edit-package-item">
                                    <strong>Service</strong>
                                    <span>${editingData?.serviceType === 'cv' ? 'CV Only' : 
                                             editingData?.serviceType === 'cover' ? 'Cover Letter Only' : 
                                             'CV + Cover Letter'}</span>
                                </div>
                                <div class="edit-package-item">
                                    <strong>Price</strong>
                                    <span>$${editingData?.amount || '0'}</span>
                                </div>
                                ${editingData?.instructions ? `
                                    <div class="edit-package-item" style="grid-column: span 2;">
                                        <strong>Instructions</strong>
                                        <span>${editingData.instructions}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Original Documents -->
                        <div class="edit-doc-group">
                            <h5><i class="fas fa-file-upload"></i> Original Documents (Client Uploaded)</h5>
                            ${hasOriginalCv ? `
                                <div class="file-item">
                                    <span>üìÑ CV: ${originalCvFile?.originalName || 'CV'}</span>
                                    <a href="/api/editing/files/${personalInfo.email}/${originalCvFile?.filename}" target="_blank" class="action-btn">View</a>
                                </div>
                            ` : ''}
                            
                            ${hasOriginalCover ? `
                                <div class="file-item">
                                    <span>üìÑ Cover Letter: ${originalCoverFile?.originalName || 'Cover Letter'}</span>
                                    <a href="/api/editing/files/${personalInfo.email}/${originalCoverFile?.filename}" target="_blank" class="action-btn">View</a>
                                </div>
                            ` : ''}
                            
                            ${!hasOriginalCv && !hasOriginalCover ? '<p>No original documents</p>' : ''}
                        </div>

                        <!-- Edited Documents -->
                        <div class="edit-doc-group">
                            <h5><i class="fas fa-file-signature"></i> Edited Documents (Admin Upload)</h5>
                            
                            <!-- CV Section -->
                            <div class="upload-section">
                                <h5><i class="fas fa-file-alt"></i> CV</h5>
                                ${hasEditedCv ? `
                                    <div class="file-status">
                                        <div class="file-info">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Edited CV uploaded: ${editedCvFile?.originalName || 'CV'}</span>
                                        </div>
                                        <div class="file-actions">
                                            <a href="/api/editing/files/${personalInfo.email}/${editedCvFile?.filename}" target="_blank" class="action-btn">View</a>
                                        </div>
                                    </div>
                                ` : needsCv ? `
                                    <button class="action-btn purple" onclick="uploadEditedCV('${personalInfo.email}')" style="width: 100%;">
                                        <i class="fas fa-upload"></i> Upload Edited CV
                                    </button>
                                ` : '<p style="color: #7f8c8d;">Not required for this package</p>'}
                            </div>

                            <!-- Cover Letter Section -->
                            <div class="upload-section">
                                <h5><i class="fas fa-envelope-open-text"></i> Cover Letter</h5>
                                ${hasEditedCover ? `
                                    <div class="file-status">
                                        <div class="file-info">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Edited Cover Letter uploaded: ${editedCoverFile?.originalName || 'Cover Letter'}</span>
                                        </div>
                                        <div class="file-actions">
                                            <a href="/api/editing/files/${personalInfo.email}/${editedCoverFile?.filename}" target="_blank" class="action-btn">View</a>
                                        </div>
                                    </div>
                                ` : needsCover ? `
                                    <button class="action-btn purple" onclick="uploadEditedCover('${personalInfo.email}')" style="width: 100%;">
                                        <i class="fas fa-upload"></i> Upload Edited Cover Letter
                                    </button>
                                ` : '<p style="color: #7f8c8d;">Not required for this package</p>'}
                            </div>
                        </div>

                        <!-- Payment Receipts Section -->
                        ${paymentReceiptsHtml}

                        <!-- Status Update and Payment Section -->
                        <div style="margin-top: 30px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <select id="statusSelect" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                                    <option value="pending" ${editingData?.status === 'pending' ? 'selected' : ''}>Pending Editing</option>
                                    <option value="editing_in_progress" ${editingData?.status === 'editing_in_progress' ? 'selected' : ''}>Editing in Progress</option>
                                    <option value="editing_completed" ${editingData?.status === 'editing_completed' ? 'selected' : ''}>Ready for Payment</option>
                                    <option value="payment_pending" ${editingData?.status === 'payment_pending' ? 'selected' : ''}>Payment Pending Verification</option>
                                    <option value="editing_paid" ${editingData?.status === 'editing_paid' ? 'selected' : ''}>Payment Verified</option>
                                </select>
                                <button class="action-btn" onclick="updateStatus('${personalInfo.email}')">Update Status</button>
                            </div>

                            ${editingData?.paymentStatus === 'paid' ? `
                                <div style="text-align: center; padding: 20px; background: #d4edda; border-radius: 8px; color: #155724; margin-top: 20px;">
                                    <i class="fas fa-check-circle"></i> <strong>Payment Verified</strong> - Documents Ready for Client
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                editSection = `
                    <div class="no-edit-request">
                        <i class="fas fa-pen-fancy"></i>
                        <h3>No Edit Service Requested</h3>
                        <p>This client has not requested any document editing services.</p>
                    </div>
                `;
            }

            // POST-APPLICATION SECTION - FIXED for job offer and contract tracking
            const postSection = app.hasApplication ? `
                <div class="post-application-section">
                    <div class="post-header">
                        <i class="fas fa-file-signature"></i>
                        <h3>Post-Application Document Tracking</h3>
                    </div>

                    <div class="document-progress">
                        <div class="document-progress-title">
                            <i class="fas fa-chart-pie"></i>
                            <span>Document Progress</span>
                        </div>
                        <div class="document-progress-grid">
                            <div class="document-progress-item">
                                <div class="label">Job Offer</div>
                                <div class="value">${app.jobOffer?.status === 'approved' ? '‚úÖ' : app.jobOffer?.status === 'uploaded' ? 'üìÑ' : '‚è≥'}</div>
                            </div>
                            <div class="document-progress-item">
                                <div class="label">Contract</div>
                                <div class="value">${app.contract?.status === 'approved' ? '‚úÖ' : app.contract?.status === 'uploaded' ? 'üìù' : '‚è≥'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Offer Section -->
                    <div class="edit-doc-group">
                        <h5><i class="fas fa-file-signature"></i> Job Offer Letter</h5>
                        
                        <div class="document-status ${app.jobOffer?.status === 'approved' ? 'completed' : ''}">
                            <i class="fas ${app.jobOffer?.status === 'approved' ? 'fa-check-circle' : app.jobOffer?.status === 'uploaded' ? 'fa-clock' : 'fa-hourglass-half'}"></i>
                            <span>
                                ${app.jobOffer?.status === 'approved' ? '‚úÖ Approved' : 
                                  app.jobOffer?.status === 'uploaded' ? 'üìÑ Uploaded - Pending Review' : 
                                  '‚è≥ Awaiting Upload'}
                            </span>
                        </div>
                        
                        ${app.jobOffer?.file ? `
                            <div class="file-status" style="margin-top: 10px;">
                                <div class="file-info">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>${app.jobOffer.file.originalName || 'Job Offer Letter'}</span>
                                </div>
                                <div class="file-actions">
                                    <a href="/api/admin/files/${personalInfo.email}/${app.jobOffer.file.filename}" target="_blank" class="action-btn">View</a>
                                </div>
                            </div>
                            <p style="margin-top: 5px; font-size: 0.85em; color: #7f8c8d;">
                                <i class="far fa-clock"></i> Uploaded: ${new Date(app.jobOffer.uploadedAt).toLocaleString()}
                            </p>
                        ` : app.application?.status === 'processed' ? `
                            <p style="color: #7f8c8d; font-style: italic;">Waiting for client to upload signed job offer...</p>
                        ` : `
                            <p style="color: #7f8c8d; font-style: italic;">Job offer will be available after application is processed.</p>
                        `}
                        
                        ${app.jobOffer?.file ? `
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <select id="jobOfferStatus" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                                    <option value="pending" ${app.jobOffer?.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="uploaded" ${app.jobOffer?.status === 'uploaded' ? 'selected' : ''}>Uploaded (Pending Review)</option>
                                    <option value="approved" ${app.jobOffer?.status === 'approved' ? 'selected' : ''}>Approved</option>
                                    <option value="rejected" ${app.jobOffer?.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                                <button class="action-btn" onclick="updateJobOfferStatus('${personalInfo.email}', document.getElementById('jobOfferStatus').value)">
                                    Update Status
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Contract Section -->
                    <div class="edit-doc-group">
                        <h5><i class="fas fa-file-contract"></i> Employment Contract</h5>
                        
                        <div class="document-status ${app.contract?.status === 'approved' ? 'completed' : ''}">
                            <i class="fas ${app.contract?.status === 'approved' ? 'fa-check-circle' : app.contract?.status === 'uploaded' ? 'fa-clock' : 'fa-hourglass-half'}"></i>
                            <span>
                                ${app.contract?.status === 'approved' ? '‚úÖ Approved' : 
                                  app.contract?.status === 'uploaded' ? 'üìù Uploaded - Pending Review' : 
                                  '‚è≥ Awaiting Upload'}
                            </span>
                        </div>
                        
                        ${app.contract?.file ? `
                            <div class="file-status" style="margin-top: 10px;">
                                <div class="file-info">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>${app.contract.file.originalName || 'Employment Contract'}</span>
                                </div>
                                <div class="file-actions">
                                    <a href="/api/admin/files/${personalInfo.email}/${app.contract.file.filename}" target="_blank" class="action-btn">View</a>
                                </div>
                            </div>
                            <p style="margin-top: 5px; font-size: 0.85em; color: #7f8c8d;">
                                <i class="far fa-clock"></i> Uploaded: ${new Date(app.contract.uploadedAt).toLocaleString()}
                            </p>
                        ` : app.application?.status === 'processed' ? `
                            <p style="color: #7f8c8d; font-style: italic;">Waiting for client to upload signed contract...</p>
                        ` : `
                            <p style="color: #7f8c8d; font-style: italic;">Contract will be available after application is processed.</p>
                        `}
                        
                        ${app.contract?.file ? `
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                <select id="contractStatus" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                                    <option value="pending" ${app.contract?.status === 'pending' ? 'selected' : ''}>Pending</option>
                                    <option value="uploaded" ${app.contract?.status === 'uploaded' ? 'selected' : ''}>Uploaded (Pending Review)</option>
                                    <option value="approved" ${app.contract?.status === 'approved' ? 'selected' : ''}>Approved</option>
                                    <option value="rejected" ${app.contract?.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                                <button class="action-btn" onclick="updateContractStatus('${personalInfo.email}', document.getElementById('contractStatus').value)">
                                    Update Status
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <div class="payment-section" style="margin-top: 20px;">
                        <h4>Document Notes</h4>
                        <p style="margin-top: 10px; color: #7f8c8d;">
                            <i class="fas fa-info-circle"></i> 
                            Job offer and contract documents are uploaded by the client after application is processed.
                            Review and approve them once they are submitted.
                        </p>
                    </div>
                </div>
            ` : '<div class="no-application-message"><i class="fas fa-info-circle"></i> No visa application found for this client.</div>';

            // NEW: Job Preferences Section
            const jobPreferencesSection = app.hasApplication && jobPreferences && (jobPreferences.preferredCountry || jobPreferences.preferredJob) ? `
                <div class="job-preferences-section">
                    <h4><i class="fas fa-briefcase"></i> Job Preferences</h4>
                    <div class="job-preferences-grid">
                        <div class="job-info-item">
                            <strong>Preferred Country</strong>
                            <span>${jobPreferences.preferredCountry || 'Not specified'}</span>
                        </div>
                        <div class="job-info-item">
                            <strong>Preferred Job</strong>
                            <span>${jobPreferences.preferredJob || 'Not specified'}</span>
                        </div>
                        ${jobPreferences.additionalInfo ? `
                            <div class="additional-info">
                                <strong>Additional Information</strong>
                                <p>${jobPreferences.additionalInfo}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : '';

            // Personal Information Section (always shown)
            const personalInfoSection = `
                <h3>Personal Information</h3>
                <div class="personal-info-grid">
                    <div class="info-item">
                        <strong>Full Name</strong>
                        <span>${personalInfo.fullName || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <strong>Email</strong>
                        <span>${personalInfo.email || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <strong>Phone</strong>
                        <span>${personalInfo.phone || 'N/A'}</span>
                    </div>
                    ${personalInfo.age ? `
                        <div class="info-item">
                            <strong>Age</strong>
                            <span>${personalInfo.age}</span>
                        </div>
                    ` : ''}
                    ${personalInfo.gender ? `
                        <div class="info-item">
                            <strong>Gender</strong>
                            <span>${formatGender(personalInfo.gender)}</span>
                        </div>
                    ` : ''}
                    ${personalInfo.maritalStatus ? `
                        <div class="info-item">
                            <strong>Marital Status</strong>
                            <span>${formatMaritalStatus(personalInfo.maritalStatus)}</span>
                        </div>
                    ` : ''}
                    ${personalInfo.country ? `
                        <div class="info-item">
                            <strong>Country</strong>
                            <span>${personalInfo.country}</span>
                        </div>
                    ` : ''}
                    ${personalInfo.visaType ? `
                        <div class="info-item">
                            <strong>Visa Type</strong>
                            <span>${personalInfo.visaType}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            // Comments Section (always shown)
            const commentsSection = `
                <h3>Admin Comments</h3>
                <div class="comment-section">
                    <textarea id="newComment" class="comment-box" placeholder="Add a comment..."></textarea>
                    <button class="action-btn" onclick="addComment('${personalInfo.email}')">Add Comment</button>
                    <div id="commentsList">
                        ${(app.comments || []).map(comment => `
                            <div class="comment">
                                <p>${comment.text}</p>
                                <small>${new Date(comment.timestamp).toLocaleString()} - ${comment.admin || 'Admin'}</small>
                            </div>
                        `).join('') || '<p>No comments yet</p>'}
                    </div>
                </div>
            `;

            // Combine everything
            content.innerHTML = `
                <!-- Section Content -->
                ${currentSection === 'review' ? reviewSection : 
                  currentSection === 'edit' ? editSection : 
                  postSection}
                
                <!-- Always visible sections -->
                ${jobPreferencesSection}
                ${personalInfoSection}
                ${commentsSection}
            `;

            // Reset delete checkbox
            const deleteCheckbox = document.getElementById('confirmDelete');
            if (deleteCheckbox) {
                deleteCheckbox.checked = false;
                document.getElementById('deleteRequestBtn').disabled = true;
            }
            
            modal.style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('applicationModal').style.display = 'none';
        }

        // Logout
        function logout() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('loginForm').reset();
            currentApplications = [];
            filteredApplications = [];
            showInfo('Logged out successfully');
        }

        // Click outside to close
        window.onclick = function(event) {
            const modal = document.getElementById('applicationModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>